-- 1. Création de la base de données avec encodage pour les émojis (utf8mb4)
CREATE DATABASE IF NOT EXISTS cif_connect_db 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE cif_connect_db;

-- 2. Création de l'utilisateur dédié (Sécurité)
-- Remplace 'TonMotDePasseComplique' par un vrai mot de passe
CREATE USER IF NOT EXISTS 'cif_admin'@'localhost' IDENTIFIED BY 'TonMotDePasseComplique';
GRANT ALL PRIVILEGES ON cif_connect_db.* TO 'cif_admin'@'localhost';
FLUSH PRIVILEGES;


CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE, -- Email institutionnel
    password_hash VARCHAR(255) NOT NULL, -- Mot de passe hashé (jamais en clair)
    
    -- Gestion du pseudo
    pseudo VARCHAR(50) NOT NULL, 
    last_pseudo_update DATETIME DEFAULT NULL, -- Pour vérifier la règle des 7 jours
    
    -- Gestion des rôles et bannissement
    role ENUM('student', 'admin', 'moderator') DEFAULT 'student',
    is_banned BOOLEAN DEFAULT FALSE,
    ban_expires_at DATETIME DEFAULT NULL, -- NULL = Ban définitif si is_banned est TRUE
    ban_reason VARCHAR(255) DEFAULT NULL,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;


CREATE TABLE chat_rooms (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    
    -- La clé d'accès. Si NULL = Salon public (Général)
    access_key VARCHAR(20) DEFAULT NULL, 
    
    created_by INT, -- L'ID de l'élève qui a créé le salon
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB;


CREATE TABLE messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT, -- Lien vers l'auteur réel (pour bannir si besoin)
    room_id INT NOT NULL,
    
    -- SNAPSHOT du pseudo : On copie le pseudo ici à l'instant T.
    -- Si l'user change de pseudo demain, ce message gardera l'ancien nom.
    author_display_name VARCHAR(50) NOT NULL, 
    
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (room_id) REFERENCES chat_rooms(id) ON DELETE CASCADE
) ENGINE=InnoDB;


CREATE TABLE reports (
    id INT AUTO_INCREMENT PRIMARY KEY,
    reporter_id INT NOT NULL, -- Celui qui signale
    message_id INT NOT NULL,  -- Le message signalé
    
    reason VARCHAR(255) NOT NULL, -- "Insulte", "Harcèlement", etc.
    status ENUM('pending', 'resolved', 'dismissed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (reporter_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
) ENGINE=InnoDB;


-- Création du chat Général (pas de clé, pas de créateur)
INSERT OR IGNORE INTO chat_rooms (name, access_key, created_by) 
VALUES ('Général', NULL, NULL);
