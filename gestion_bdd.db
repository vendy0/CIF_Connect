-- 1. Table des utilisateurs
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    pseudo TEXT NOT NULL,
    last_pseudo_update DATETIME,
    role TEXT DEFAULT 'student', -- SQLite gère mal les ENUM, on utilise TEXT
    is_banned BOOLEAN DEFAULT 0,
    ban_expires_at DATETIME,
    ban_reason TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. Table des salons (Mise à jour pour inclure la DESCRIPTION)
CREATE TABLE IF NOT EXISTS chat_rooms (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT, -- Ajouté pour correspondre à create_room_view.py
    access_key TEXT, -- NULL = Public, Sinon code d'invitation
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
);

-- 3. Table des messages
CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    room_id INTEGER NOT NULL,
    author_display_name TEXT NOT NULL, -- Snapshot du pseudo
    content TEXT NOT NULL,
    message_type TEXT DEFAULT 'chat_message', -- Ajouté pour correspondre à chat_view.py
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (room_id) REFERENCES chat_rooms(id) ON DELETE CASCADE
);

-- 4. Table des signalements
CREATE TABLE IF NOT EXISTS reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    reporter_id INTEGER NOT NULL,
    message_id INTEGER NOT NULL,
    reason TEXT NOT NULL,
    status TEXT DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (reporter_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
);

-- 5. Données initiales (Salon Général et Projet Python)
INSERT OR IGNORE INTO chat_rooms (id, name, description, access_key) 
VALUES (1, 'Salon Général', 'Discussion libre pour tous', NULL);

INSERT OR IGNORE INTO chat_rooms (id, name, description, access_key) 
VALUES (2, 'Projet Python', 'Groupe de travail dév', 'CODE123');
